{% extends "base.html" %}

{% block title %}View Form - Health Insurance{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">Health Insurance Form Details</h2>
            </div>
            <div class="col-auto ms-auto d-print-none">
                <div class="btn-list">
                    <a href="{{ url_for('health_insurance.index') }}" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 11l-4 4l4 4m-4 -4h11a4 4 0 0 0 0 -8h-1" /></svg>
                        Back to List
                    </a>
                    {% if current_user.agent_pdf_generated < current_user.agent_pdf_limit %}
                    <a href="{{ url_for('health_insurance.generate_pdf_direct', form_id=form.id) }}" 
                       class="btn btn-success"
                       onclick="return confirmPDFGeneration(event)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M12 11v6" /><path d="M9 14l3 3l3 -3" /></svg>
                        Generate & Download PDF
                    </a>
                    {% else %}
                    <button class="btn btn-secondary" disabled title="PDF limit reached">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M12 11v6" /><path d="M9 14l3 3l3 -3" /></svg>
                        PDF Limit Reached
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        <div class="row">
            <div class="col-12">
                <!-- PDF Usage Alert -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>
                        </div>
                        <div class="ms-2">
                            <h4 class="alert-title">PDF Generation Info</h4>
                            <div class="text-muted">
                                <strong>PDF Credits:</strong> {{ current_user.agent_pdf_generated }} / {{ current_user.agent_pdf_limit }} used<br>
                                <strong>Note:</strong> Each PDF generation uses 1 credit. PDFs are generated fresh each time and downloaded directly.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Customer Information</h3>
                        <div class="card-actions">
                            <span class="badge bg-info">{{ form.language.upper() }}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="datagrid">
                            <div class="datagrid-item">
                                <div class="datagrid-title">Name</div>
                                <div class="datagrid-content">{{ form.name }}</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Email</div>
                                <div class="datagrid-content">{{ form.email }}</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Mobile</div>
                                <div class="datagrid-content">{{ form.mobile }}</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">City</div>
                                <div class="datagrid-content">{{ form.city_of_residence }} ({{ form.tier_city }})</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Insurance Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="datagrid">
                            <div class="datagrid-item">
                                <div class="datagrid-title">Age</div>
                                <div class="datagrid-content">{{ form.age }} years</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Family Members</div>
                                <div class="datagrid-content">{{ form.number_of_members }}</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Eldest Member Age</div>
                                <div class="datagrid-content">{{ form.eldest_member_age }} years</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Pre-existing Diseases</div>
                                <div class="datagrid-content">
                                    <span class="badge bg-{{ 'danger' if form.pre_existing_diseases == 'Yes' else 'success' }}">
                                        {{ form.pre_existing_diseases }}
                                    </span>
                                </div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Major Surgery History</div>
                                <div class="datagrid-content">
                                    <span class="badge bg-{{ 'warning' if form.major_surgery == 'Yes' else 'success' }}">
                                        {{ form.major_surgery }}
                                    </span>
                                </div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Existing Insurance</div>
                                <div class="datagrid-content">
                                    <span class="badge bg-{{ 'info' if form.existing_insurance == 'Yes' else 'secondary' }}">
                                        {{ form.existing_insurance }}
                                    </span>
                                </div>
                            </div>
                            {% if form.existing_insurance == 'Yes' %}
                            <div class="datagrid-item">
                                <div class="datagrid-title">Current Coverage</div>
                                <div class="datagrid-content">₹{{ "{:,.0f}".format(form.current_coverage) }}</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Port Policy</div>
                                <div class="datagrid-content">{{ form.port_policy }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Submission Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="datagrid">
                            <div class="datagrid-item">
                                <div class="datagrid-title">Submitted On</div>
                                <div class="datagrid-content">{{ form.created_at.strftime('%Y-%m-%d %H:%M:%S') if form.created_at else '-' }}</div>
                            </div>
                            <div class="datagrid-item">
                                <div class="datagrid-title">Form Language</div>
                                <div class="datagrid-content">
                                    {% set lang_map = {'en': 'English', 'hi': 'हिंदी', 'mr': 'मराठी', 'gu': 'ગુજરાતી', 'te': 'తెలుగు', 'bn': 'বাংলা', 'kn': 'ಕನ್ನಡ', 'ta': 'தமிழ்', 'ml': 'മലയാളം'} %}
                                    {{ lang_map.get(form.language, form.language) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmPDFGeneration(event) {
    const remaining = {{ current_user.agent_pdf_limit - current_user.agent_pdf_generated }};
    const message = `Are you sure you want to generate this PDF?\n\nThis will use 1 PDF credit.\nYou have ${remaining} PDF credits remaining.\n\nThe PDF will be generated and downloaded immediately.`;
    
    if (!confirm(message)) {
        event.preventDefault();
        return false;
    }
    
    // Show loading state
    const btn = event.target.closest('a');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating PDF...';
    btn.classList.add('disabled');
    
    // Reset after a timeout in case something goes wrong
    setTimeout(() => {
        btn.innerHTML = originalContent;
        btn.classList.remove('disabled');
    }, 30000); // 30 seconds timeout
    
    return true;
}
</script>
{% endblock %}