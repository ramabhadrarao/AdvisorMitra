<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>{{ translations.title }}</title>
    <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <style>
        body {
            background-color: #f4f6fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .agent-info {
            background-color: #206bc4;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .form-card {
            border-radius: 0 0 10px 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .required::after {
            content: " *";
            color: #d63939;
        }
        .progress-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #206bc4, #28a745);
            width: 0%;
            transition: width 0.5s ease;
        }
        .field-completed {
            border-left: 3px solid #28a745;
            background-color: #f8fff9;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .typing-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        Connecting...
    </div>

    <!-- Typing Indicator -->
    <div id="typingIndicator" class="typing-indicator">
        üìù Sending updates to your advisor...
    </div>

    <div class="form-container">
        <div class="agent-info">
            <h2>{{ translations.title }}</h2>
            <p class="mb-0">{{ translations.advisor_title if translations.success else 'Your Financial Advisor' }}: <strong>{{ agent_name }}</strong></p>
            {% if agent_phone %}
            <p class="mb-0">{{ translations.fields.mobile if translations.fields else 'Contact' }}: <strong>{{ agent_phone }}</strong></p>
            {% endif %}
        </div>
        
        <form method="post" class="card form-card" id="healthForm">
            <div class="card-body">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="text-center mb-3">
                    <small class="text-muted" id="progressText">0% Complete</small>
                </div>
                
                <div class="mb-4">
                    <h3 class="card-title">{{ translations.subtitle }}</h3>
                    <p class="text-muted">{{ translations.mandatory_note }}</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.name }}</label>
                        <input type="text" name="name" class="form-control" required 
                               data-field="name">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.email }}</label>
                        <input type="email" name="email" class="form-control" required
                               data-field="email">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.mobile }}</label>
                        <input type="tel" name="mobile" class="form-control" pattern="[0-9]{10}" required
                               data-field="mobile">
                        <small class="form-hint">{{ translations.fields.mobile_hint }}</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.city_of_residence }}</label>
                        <select name="city_of_residence" class="form-select" required
                                data-field="city_of_residence">
                            <option value="">{{ translations.options.select_city }}</option>
                            {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.age }}</label>
                        <input type="number" name="age" class="form-control" min="18" max="100" required
                               data-field="age">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.number_of_members }}</label>
                        <input type="number" name="number_of_members" class="form-control" min="1" max="10" value="1" required
                               data-field="number_of_members">
                        <small class="form-hint">{{ translations.fields.number_of_members_hint }}</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label required">{{ translations.fields.eldest_member_age }}</label>
                    <input type="number" name="eldest_member_age" class="form-control" min="18" max="100" required
                           data-field="eldest_member_age">
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.pre_existing_diseases }}</label>
                        <select name="pre_existing_diseases" class="form-select" required
                                data-field="pre_existing_diseases">
                            <option value="">{{ translations.options.select }}</option>
                            <option value="Yes">{{ translations.options.yes }}</option>
                            <option value="No">{{ translations.options.no }}</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.major_surgery }}</label>
                        <select name="major_surgery" class="form-select" required
                                data-field="major_surgery">
                            <option value="">{{ translations.options.select }}</option>
                            <option value="Yes">{{ translations.options.yes }}</option>
                            <option value="No">{{ translations.options.no }}</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label required">{{ translations.fields.existing_insurance }}</label>
                    <select name="existing_insurance" class="form-select" required 
                            data-field="existing_insurance" onchange="toggleInsuranceFields(this.value)">
                        <option value="">{{ translations.options.select }}</option>
                        <option value="Yes">{{ translations.options.yes }}</option>
                        <option value="No">{{ translations.options.no }}</option>
                    </select>
                </div>
                
                <div id="insurance-details" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ translations.fields.current_coverage }}</label>
                            <input type="number" name="current_coverage" class="form-control" min="0" step="50000" value="0"
                                   data-field="current_coverage">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ translations.fields.port_policy }}</label>
                            <select name="port_policy" class="form-select"
                                    data-field="port_policy">
                                <option value="No">{{ translations.options.no }}</option>
                                <option value="Yes">{{ translations.options.yes }}</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <h4 class="alert-title">{{ translations.privacy_title }}</h4>
                    <div class="text-muted">{{ translations.privacy_text }}</div>
                </div>
            </div>
            
            <div class="card-footer text-end">
                <button type="submit" class="btn btn-primary">{{ translations.fields.submit_button }}</button>
            </div>
        </form>
    </div>
    
    <script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script>
        // FIXED: SocketIO connection for live progress with better error handling
        const socket = io();
        const token = "{{ token }}";
        let completedFields = new Set();
        const totalFields = 12; // Total required fields
        let isConnected = false;
        let connectionAttempts = 0;
        const maxConnectionAttempts = 5;
        
        // Debouncing variables
        let updateQueue = new Map(); // Store pending updates
        let updateTimer = null;
        let typingTimer = null;
        
        console.log('üöÄ Initializing form with token:', token);
        
        // Connection handlers with retry logic
        socket.on('connect', function() {
            console.log('‚úÖ Connected to server');
            isConnected = true;
            connectionAttempts = 0;
            updateConnectionStatus(true);
            
            // Send initial form started event
            sendUpdate('form_started', 'true');
        });
        
        socket.on('disconnect', function() {
            console.log('‚ùå Disconnected from server');
            isConnected = false;
            updateConnectionStatus(false);
            
            // Attempt reconnection
            if (connectionAttempts < maxConnectionAttempts) {
                connectionAttempts++;
                console.log(`üîÑ Attempting reconnection ${connectionAttempts}/${maxConnectionAttempts}...`);
                setTimeout(() => {
                    socket.connect();
                }, 2000 * connectionAttempts); // Exponential backoff
            }
        });
        
        socket.on('connect_error', function(error) {
            console.error('‚ùå Connection error:', error);
            isConnected = false;
            updateConnectionStatus(false);
        });
        
        socket.on('error', function(error) {
            console.error('‚ùå Socket error:', error);
        });
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = 'üü¢ Live tracking active';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = 'üî¥ Disconnected';
            }
        }
        
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            
            // Hide after 2 seconds
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
        
        function sendUpdate(fieldName, fieldValue) {
            if (isConnected) {
                const updateData = {
                    token: token,
                    field_name: fieldName,
                    field_value: fieldValue,
                    progress_percentage: Math.min(100, (completedFields.size / totalFields) * 100),
                    completed_fields_count: completedFields.size,
                    total_fields: totalFields,
                    timestamp: new Date().toISOString()
                };
                
                socket.emit('form_field_update', updateData);
                console.log('üì° Update sent:', fieldName, '=', fieldValue);
            } else {
                console.warn('‚ö†Ô∏è Not connected, queuing update:', fieldName, '=', fieldValue);
                // Store in queue for when connection is restored
                updateQueue.set(fieldName, fieldValue);
            }
        }
        
        function queueUpdate(fieldName, fieldValue) {
            // Add to queue
            updateQueue.set(fieldName, fieldValue);
            
            // Show typing indicator
            showTypingIndicator();
            
            // Clear existing timer
            if (updateTimer) {
                clearTimeout(updateTimer);
            }
            
            // Set new timer to send updates after 500ms of no activity
            updateTimer = setTimeout(() => {
                // Send all queued updates
                for (const [field, value] of updateQueue) {
                    sendUpdate(field, value);
                }
                
                // Clear queue
                updateQueue.clear();
                updateTimer = null;
            }, 500);
        }
        
        function updateProgress(element) {
            const fieldName = element.dataset.field;
            const fieldValue = element.value;
            
            console.log('üìù Field updated:', fieldName, '=', fieldValue);
            
            // Update local progress immediately
            if (fieldValue && fieldValue.trim() !== '') {
                completedFields.add(fieldName);
                element.classList.add('field-completed');
            } else {
                completedFields.delete(fieldName);
                element.classList.remove('field-completed');
            }
            
            // Calculate progress
            const percentage = Math.min(100, (completedFields.size / totalFields) * 100);
            
            // Update progress bar immediately
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = Math.round(percentage) + '% Complete';
            
            // Queue the update to send to server (debounced)
            queueUpdate(fieldName, fieldValue);
        }
        
        function toggleInsuranceFields(value) {
            const detailsDiv = document.getElementById('insurance-details');
            if (value === 'Yes') {
                detailsDiv.style.display = 'block';
                document.querySelector('input[name="current_coverage"]').required = false; // Optional field
                document.querySelector('select[name="port_policy"]').required = false; // Optional field
            } else {
                detailsDiv.style.display = 'none';
                document.querySelector('input[name="current_coverage"]').required = false;
                document.querySelector('select[name="port_policy"]').required = false;
            }
            
            // Update progress for the insurance selection
            updateProgress(document.querySelector('select[name="existing_insurance"]'));
        }
        
        // FIXED: Enhanced event listeners setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Setting up form field listeners');
            
            const formElements = document.querySelectorAll('[data-field]');
            console.log('üìã Found', formElements.length, 'form fields');
            
            formElements.forEach((element, index) => {
                console.log(`üìù Setting up field ${index + 1}:`, element.dataset.field);
                
                // For text inputs - use input event with debouncing
                if (element.type === 'text' || element.type === 'email' || element.type === 'tel' || element.type === 'number') {
                    element.addEventListener('input', function() {
                        updateProgress(this);
                    });
                    
                    // Also listen for paste events
                    element.addEventListener('paste', function() {
                        setTimeout(() => {
                            updateProgress(this);
                        }, 100); // Small delay to allow paste to complete
                    });
                }
                
                // For selects and immediate changes - use change event
                element.addEventListener('change', function() {
                    updateProgress(this);
                });
                
                // For focus events - send immediate update if field has value
                element.addEventListener('focus', function() {
                    if (this.value && this.value.trim() !== '') {
                        sendUpdate(this.dataset.field + '_focused', this.value);
                    }
                });
                
                // Check for existing values on page load
                if (element.value && element.value.trim() !== '') {
                    updateProgress(element);
                }
            });
            
            console.log('‚úÖ Form field listeners set up complete');
        });
        
        // Form submission
        document.getElementById('healthForm').addEventListener('submit', function(e) {
            console.log('üì§ Form being submitted');
            
            // Send any pending updates immediately
            if (updateTimer) {
                clearTimeout(updateTimer);
                for (const [field, value] of updateQueue) {
                    sendUpdate(field, value);
                }
                updateQueue.clear();
            }
            
            // Send form submission event
            sendUpdate('form_submitted', 'true');
            
            // Small delay to ensure the update is sent before form submission
            e.preventDefault();
            setTimeout(() => {
                document.getElementById('healthForm').submit();
            }, 500);
        });
        
        // Handle connection restoration
        socket.on('connect', function() {
            // Send any queued updates when connection is restored
            if (updateQueue.size > 0) {
                console.log('üîÑ Sending queued updates after reconnection');
                for (const [field, value] of updateQueue) {
                    sendUpdate(field, value);
                }
                updateQueue.clear();
            }
        });
        
        // Debug: Log socket events (remove in production)
        socket.onAny((event, ...args) => {
            if (event !== 'progress_update') { // Avoid spam
                console.log('üîç Socket event:', event, args);
            }
        });
    </script>
</body>
</html>