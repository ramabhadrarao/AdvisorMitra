<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>{{ translations.title }}</title>
    <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <style>
        body {
            background-color: #f4f6fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .agent-info {
            background-color: #206bc4;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .form-card {
            border-radius: 0 0 10px 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .required::after {
            content: " *";
            color: #d63939;
        }
        .progress-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #206bc4, #28a745);
            width: 0%;
            transition: width 0.5s ease;
        }
        .field-completed {
            border-left: 3px solid #28a745;
            background-color: #f8fff9;
        }
        .field-restored {
            border-left: 3px solid #ffc107;
            background-color: #fffbf0;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .typing-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }
        .restoration-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .restore-btn {
            background: #ffc107;
            border: none;
            color: #000;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }
        .restore-btn:hover {
            background: #e0a800;
        }
        .clear-btn {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .clear-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        Connecting...
    </div>

    <!-- Typing Indicator -->
    <div id="typingIndicator" class="typing-indicator">
        üìù Sending updates to your advisor...
    </div>

    <div class="form-container">
        <div class="agent-info">
            <h2>{{ translations.title }}</h2>
            <p class="mb-0">{{ translations.advisor_title if translations.success else 'Your Financial Advisor' }}: <strong>{{ agent_name }}</strong></p>
            {% if agent_phone %}
            <p class="mb-0">{{ translations.fields.mobile if translations.fields else 'Contact' }}: <strong>{{ agent_phone }}</strong></p>
            {% endif %}
        </div>
        
        <!-- Restoration Notice (Hidden by default) -->
        <div id="restorationNotice" class="restoration-notice" style="display: none;">
            <div class="d-flex align-items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon text-warning me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M12 9v2m0 4v.01" />
                    <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75" />
                </svg>
                <strong>Form Data Found</strong>
            </div>
            <p class="mb-3">We found some previously filled information for this form. Would you like to restore it?</p>
            <div>
                <button class="restore-btn" onclick="restoreFormData()">
                    üìã Restore Previous Data
                </button>
                <button class="clear-btn" onclick="clearPreviousData()">
                    üóëÔ∏è Start Fresh
                </button>
            </div>
        </div>
        
        <form method="post" class="card form-card" id="healthForm">
            <div class="card-body">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="text-center mb-3">
                    <small class="text-muted" id="progressText">0% Complete</small>
                </div>
                
                <div class="mb-4">
                    <h3 class="card-title">{{ translations.subtitle }}</h3>
                    <p class="text-muted">{{ translations.mandatory_note }}</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.name }}</label>
                        <input type="text" name="name" class="form-control" required 
                               data-field="name">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.email }}</label>
                        <input type="email" name="email" class="form-control" required
                               data-field="email">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.mobile }}</label>
                        <input type="tel" name="mobile" class="form-control" pattern="[0-9]{10}" required
                               data-field="mobile">
                        <small class="form-hint">{{ translations.fields.mobile_hint }}</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.city_of_residence }}</label>
                        <select name="city_of_residence" class="form-select" required
                                data-field="city_of_residence">
                            <option value="">{{ translations.options.select_city }}</option>
                            {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.age }}</label>
                        <input type="number" name="age" class="form-control" min="18" max="100" required
                               data-field="age">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.number_of_members }}</label>
                        <input type="number" name="number_of_members" class="form-control" min="1" max="10" value="1" required
                               data-field="number_of_members">
                        <small class="form-hint">{{ translations.fields.number_of_members_hint }}</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label required">{{ translations.fields.eldest_member_age }}</label>
                    <input type="number" name="eldest_member_age" class="form-control" min="18" max="100" required
                           data-field="eldest_member_age">
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.pre_existing_diseases }}</label>
                        <select name="pre_existing_diseases" class="form-select" required
                                data-field="pre_existing_diseases">
                            <option value="">{{ translations.options.select }}</option>
                            <option value="Yes">{{ translations.options.yes }}</option>
                            <option value="No">{{ translations.options.no }}</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">{{ translations.fields.major_surgery }}</label>
                        <select name="major_surgery" class="form-select" required
                                data-field="major_surgery">
                            <option value="">{{ translations.options.select }}</option>
                            <option value="Yes">{{ translations.options.yes }}</option>
                            <option value="No">{{ translations.options.no }}</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label required">{{ translations.fields.existing_insurance }}</label>
                    <select name="existing_insurance" class="form-select" required 
                            data-field="existing_insurance" onchange="toggleInsuranceFields(this.value)">
                        <option value="">{{ translations.options.select }}</option>
                        <option value="Yes">{{ translations.options.yes }}</option>
                        <option value="No">{{ translations.options.no }}</option>
                    </select>
                </div>
                
                <div id="insurance-details" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ translations.fields.current_coverage }}</label>
                            <input type="number" name="current_coverage" class="form-control" min="0" step="50000" value="0"
                                   data-field="current_coverage">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ translations.fields.port_policy }}</label>
                            <select name="port_policy" class="form-select"
                                    data-field="port_policy">
                                <option value="No">{{ translations.options.no }}</option>
                                <option value="Yes">{{ translations.options.yes }}</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Language Selection for PDF Report -->
                <div class="mb-3">
                    <label class="form-label required">{{ translations.fields.report_language if translations.fields.report_language else 'Preferred Report Language' }}</label>
                    <select name="report_language" class="form-select" required data-field="report_language">
                        <option value="">{{ translations.options.select }}</option>
                        <option value="en" {% if language == 'en' %}selected{% endif %}>English</option>
                        <option value="hi" {% if language == 'hi' %}selected{% endif %}>‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                        <option value="mr" {% if language == 'mr' %}selected{% endif %}>‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                        <option value="gu" {% if language == 'gu' %}selected{% endif %}>‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                        <option value="te" {% if language == 'te' %}selected{% endif %}>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                        <option value="bn" {% if language == 'bn' %}selected{% endif %}>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                        <option value="kn" {% if language == 'kn' %}selected{% endif %}>‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                        <option value="ta" {% if language == 'ta' %}selected{% endif %}>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                        <option value="ml" {% if language == 'ml' %}selected{% endif %}>‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
                    </select>
                    <small class="form-hint">{{ translations.fields.report_language_hint if translations.fields.report_language_hint else 'Your health insurance report will be generated in this language' }}</small>
                </div>
                
                <div class="alert alert-info">
                    <h4 class="alert-title">{{ translations.privacy_title }}</h4>
                    <div class="text-muted">{{ translations.privacy_text }}</div>
                </div>
            </div>
            
            <div class="card-footer text-end">
                <button type="submit" class="btn btn-primary">{{ translations.fields.submit_button }}</button>
            </div>
        </form>
    </div>
    
    <script src="https://unpkg.com/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script>
        // ENHANCED: Form state restoration with SocketIO
        const socket = io();
        const token = "{{ token }}";
        let completedFields = new Set();
        const totalFields = 13; // Updated to include report_language
        let isConnected = false;
        let connectionAttempts = 0;
        const maxConnectionAttempts = 5;
        let hasRestoredData = false;
        let previousFormData = {};
        
        // Debouncing variables
        let updateQueue = new Map();
        let updateTimer = null;
        let typingTimer = null;
        
        console.log('üöÄ Initializing form with token:', token);
        
        // Connection handlers with retry logic
        socket.on('connect', function() {
            console.log('‚úÖ Connected to server');
            isConnected = true;
            connectionAttempts = 0;
            updateConnectionStatus(true);
            
            // Request existing form progress immediately
            requestFormProgress();
        });
        
        socket.on('disconnect', function() {
            console.log('‚ùå Disconnected from server');
            isConnected = false;
            updateConnectionStatus(false);
            
            if (connectionAttempts < maxConnectionAttempts) {
                connectionAttempts++;
                console.log(`üîÑ Attempting reconnection ${connectionAttempts}/${maxConnectionAttempts}...`);
                setTimeout(() => {
                    socket.connect();
                }, 2000 * connectionAttempts);
            }
        });
        
        socket.on('connect_error', function(error) {
            console.error('‚ùå Connection error:', error);
            isConnected = false;
            updateConnectionStatus(false);
        });
        
        // NEW: Handle form progress response
        socket.on('form_progress_response', function(data) {
            console.log('üìÑ Received form progress:', data);
            if (data.success && data.progress && data.progress.completed_fields) {
                previousFormData = data.progress.completed_fields;
                
                // Check if there's meaningful data to restore
                const meaningfulFields = Object.keys(previousFormData).filter(key => {
                    const value = previousFormData[key];
                    return value && value.toString().trim() !== '' && 
                           key !== 'form_started' && key !== 'form_submitted';
                });
                
                if (meaningfulFields.length > 0) {
                    console.log(`üíæ Found ${meaningfulFields.length} fields to restore:`, meaningfulFields);
                    showRestorationNotice();
                } else {
                    console.log('üÜï No previous data found, starting fresh');
                    sendUpdate('form_started', 'true');
                }
            } else {
                console.log('üÜï No previous progress found, starting fresh');
                sendUpdate('form_started', 'true');
            }
        });
        
        function requestFormProgress() {
            console.log('üì° Requesting form progress...');
            socket.emit('get_form_progress', { token: token });
        }
        
        function showRestorationNotice() {
            const notice = document.getElementById('restorationNotice');
            notice.style.display = 'block';
            
            // Auto-hide after 15 seconds if no action taken
            setTimeout(() => {
                if (notice.style.display !== 'none') {
                    notice.style.display = 'none';
                    console.log('‚è∞ Auto-starting fresh after timeout');
                    sendUpdate('form_started', 'true');
                }
            }, 15000);
        }
        
        function restoreFormData() {
            console.log('üîÑ Restoring form data...', previousFormData);
            hasRestoredData = true;
            
            // Hide notice
            document.getElementById('restorationNotice').style.display = 'none';
            
            // Restore each field
            Object.keys(previousFormData).forEach(fieldName => {
                const value = previousFormData[fieldName];
                if (value && value.toString().trim() !== '' && 
                    fieldName !== 'form_started' && fieldName !== 'form_submitted') {
                    
                    const element = document.querySelector(`[data-field="${fieldName}"]`);
                    if (element) {
                        element.value = value;
                        element.classList.add('field-restored');
                        completedFields.add(fieldName);
                        
                        console.log(`‚úÖ Restored ${fieldName}: ${value}`);
                        
                        // Handle special cases
                        if (fieldName === 'existing_insurance') {
                            toggleInsuranceFields(value);
                        }
                    }
                }
            });
            
            // Update progress immediately
            updateProgressDisplay();
            
            // Send restoration notification
            sendUpdate('form_restored', 'true');
            
            // Show success message
            showNotification('‚úÖ Previous data restored successfully!', 'success');
        }
        
        function clearPreviousData() {
            console.log('üóëÔ∏è Clearing previous data and starting fresh');
            hasRestoredData = false;
            previousFormData = {};
            
            // Hide notice
            document.getElementById('restorationNotice').style.display = 'none';
            
            // Clear all form fields
            document.querySelectorAll('[data-field]').forEach(element => {
                if (element.type === 'number' && element.name === 'number_of_members') {
                    element.value = '1'; // Keep default value
                } else if (element.name === 'current_coverage') {
                    element.value = '0'; // Keep default value
                } else if (element.name === 'report_language') {
                    element.value = '{{ language }}'; // Set to form's default language
                } else {
                    element.value = '';
                }
                element.classList.remove('field-completed', 'field-restored');
            });
            
            // Reset progress
            completedFields.clear();
            updateProgressDisplay();
            
            // Send fresh start notification
            sendUpdate('form_started', 'true');
            
            // Show success message
            showNotification('üÜï Starting with a fresh form!', 'info');
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible`;
            notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 2000; min-width: 300px;';
            notification.innerHTML = `
                <div>${message}</div>
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = 'üü¢ Live tracking active';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = 'üî¥ Disconnected';
            }
        }
        
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
        
        function sendUpdate(fieldName, fieldValue) {
            if (isConnected) {
                const updateData = {
                    token: token,
                    field_name: fieldName,
                    field_value: fieldValue,
                    progress_percentage: Math.min(100, (completedFields.size / totalFields) * 100),
                    completed_fields_count: completedFields.size,
                    total_fields: totalFields,
                    timestamp: new Date().toISOString(),
                    restored: hasRestoredData
                };
                
                socket.emit('form_field_update', updateData);
                console.log('üì° Update sent:', fieldName, '=', fieldValue);
            } else {
                console.warn('‚ö†Ô∏è Not connected, queuing update:', fieldName, '=', fieldValue);
                updateQueue.set(fieldName, fieldValue);
            }
        }
        
        function queueUpdate(fieldName, fieldValue) {
            updateQueue.set(fieldName, fieldValue);
            showTypingIndicator();
            
            if (updateTimer) {
                clearTimeout(updateTimer);
            }
            
            updateTimer = setTimeout(() => {
                for (const [field, value] of updateQueue) {
                    sendUpdate(field, value);
                }
                updateQueue.clear();
                updateTimer = null;
            }, 500);
        }
        
        function updateProgress(element) {
            const fieldName = element.dataset.field;
            const fieldValue = element.value;
            
            console.log('üìù Field updated:', fieldName, '=', fieldValue);
            
            // Update local progress immediately
            if (fieldValue && fieldValue.trim() !== '') {
                completedFields.add(fieldName);
                element.classList.add('field-completed');
                element.classList.remove('field-restored'); // Remove restoration styling
            } else {
                completedFields.delete(fieldName);
                element.classList.remove('field-completed', 'field-restored');
            }
            
            updateProgressDisplay();
            queueUpdate(fieldName, fieldValue);
        }
        
        function updateProgressDisplay() {
            const percentage = Math.min(100, (completedFields.size / totalFields) * 100);
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = Math.round(percentage) + '% Complete';
        }
        
        function toggleInsuranceFields(value) {
            const detailsDiv = document.getElementById('insurance-details');
            if (value === 'Yes') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
            
            updateProgress(document.querySelector('select[name="existing_insurance"]'));
        }
        
        // Enhanced event listeners setup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Setting up form field listeners');
            
            const formElements = document.querySelectorAll('[data-field]');
            console.log('üìã Found', formElements.length, 'form fields');
            
            formElements.forEach((element, index) => {
                console.log(`üìù Setting up field ${index + 1}:`, element.dataset.field);
                
                if (element.type === 'text' || element.type === 'email' || element.type === 'tel' || element.type === 'number') {
                    element.addEventListener('input', function() {
                        updateProgress(this);
                    });
                    
                    element.addEventListener('paste', function() {
                        setTimeout(() => {
                            updateProgress(this);
                        }, 100);
                    });
                }
                
                element.addEventListener('change', function() {
                    updateProgress(this);
                });
                
                element.addEventListener('focus', function() {
                    if (this.value && this.value.trim() !== '') {
                        sendUpdate(this.dataset.field + '_focused', this.value);
                    }
                });
                
                // Check for existing values on page load
                if (element.value && element.value.trim() !== '') {
                    updateProgress(element);
                }
            });
            
            console.log('‚úÖ Form field listeners set up complete');
        });
        
        // Form submission
        document.getElementById('healthForm').addEventListener('submit', function(e) {
            console.log('üì§ Form being submitted');
            
            if (updateTimer) {
                clearTimeout(updateTimer);
                for (const [field, value] of updateQueue) {
                    sendUpdate(field, value);
                }
                updateQueue.clear();
            }
            
            sendUpdate('form_submitted', 'true');
            
            e.preventDefault();
            setTimeout(() => {
                document.getElementById('healthForm').submit();
            }, 500);
        });
        
        // Handle connection restoration
        socket.on('connect', function() {
            if (updateQueue.size > 0) {
                console.log('üîÑ Sending queued updates after reconnection');
                for (const [field, value] of updateQueue) {
                    sendUpdate(field, value);
                }
                updateQueue.clear();
            }
        });
        
        // Debug logging
        socket.onAny((event, ...args) => {
            if (event !== 'progress_update') {
                console.log('üîç Socket event:', event, args);
            }
        });
    </script>
</body>
</html>